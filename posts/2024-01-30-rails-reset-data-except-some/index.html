<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=author content="dvogt"><meta name=description content="personal developer blog for some coding notes."><meta name=keywords content="blog,tech,develop,software,coding"><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><link rel=canonical href=/posts/2024-01-30-rails-reset-data-except-some/><base href=/><meta property="og:title" content="Rails - drop database data"><meta property="og:description" content="Drop database data, except some tables"><meta property="og:type" content="article"><meta property="og:url" content="/posts/2024-01-30-rails-reset-data-except-some/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-30T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-06T08:35:11+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Rails - drop database data"><meta name=twitter:description content="Drop database data, except some tables"><meta itemprop=name content="Rails - drop database data"><meta itemprop=description content="Drop database data, except some tables"><meta itemprop=datePublished content="2024-01-30T00:00:00+00:00"><meta itemprop=dateModified content="2025-02-06T08:35:11+01:00"><meta itemprop=wordCount content="209"><meta itemprop=keywords content="ruby,rails,development,programming,"><link rel=stylesheet href=css/layout.css><link rel=stylesheet href=css/syntax.css><link rel=stylesheet href=css/tweet.css><style type=text/css>body{background-color:#202020;color:#dbdbdb}a{color:#dbdbdb}pre{background:#1d1f21;border:1px solid #dbdbdb;border-radius:5px}code{background:#1d1f21}blockquote{background:#1d1f21;border-left:3px solid #dbdbdb}table{margin:1em auto;border-collapse:collapse}table,th,td{border:1px solid #dbdbdb}th{background:#dbdbdb;color:#202020}.siteTitle a{color:#b3b6b7}.post .content h1{color:#b3b6b7}.post .content h2{color:#b3b6b7}.post .content h3{color:#b3b6b7}.post .content h4{color:#b3b6b7}.post .content h5{color:#b3b6b7}.post .content h6{color:#b3b6b7}.post .content a:hover{color:#b3b6b7}.social-link:hover{color:#b3b6b7}.nav-item-title:hover{color:#b3b6b7}.tag a:hover{color:#b3b6b7}.copyright{color:#404040}.poweredby{color:#404040}.poweredby a{color:#404040}.post-preview .title a{color:#b3b6b7}.content-item a:hover{text-decoration:underline;color:#b3b6b7}.post-list .title{color:#b3b6b7}.rmore{color:#b3b6b7}.terms .term a:hover{text-decoration:underline;color:#b3b6b7}</style><script async defer data-website-id=aeec65b5-9542-46f0-bd03-fa96813535bb src=https://umami.vogt.dev/umami.js></script><title>Rails - drop database data</title></head><body><div class=main><header><div class=header-bar><nav><div class=siteTitle><a href=/>dima.</a></div><a class=nav-item href=/now/><div class=nav-item-title>now</div></a><a class=nav-item href=/toots/><div class=nav-item-title>tweets</div></a><a class="nav-item
active" href=/posts><div class=nav-item-title>blog</div></a><a class=nav-item href=/><div class=nav-item-title>web</div></a><a class=nav-item href=/tags/><div class=nav-item-title>tags</div></a><a class=nav-item href=/index.xml><div class=nav-item-title>rss</div></a></nav></div><div class=social-links-header></div></header><article class=post><h1 class=title>Rails - drop database data</h1><p class=description>Drop database data, except some tables</p><div class=content><p>If you want to drop your data in <code>rails</code> you do it usually with <code>bin/rails db:drop</code> or <code>bin/rails db:schema:load</code>. But if you have a case, you need to keep
some data in different tables, you need to do it with a specific <code>Rake task</code>.</p><p>I had a case for a demo environment, where we are reseting all data every sunday
for presentations. But we have some tables with &ldquo;static&rdquo; calculation data for
different use-cases, that we need to skip in <em><strong>resetting</strong></em> task and skip at
<em><strong>re-seeding</strong></em> job.</p><p>For scheduling repeating jobs, I have <a href=https://github.com/jmettraux/rufus-scheduler>rufu-scheduler</a> in the project, to run jobs on a specific timebase.</p><p>i.e. <code>rufus_scheduler.rb</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>scheduler<span style=color:#f92672>.</span>cron <span style=color:#e6db74>&#34;0 0 * * 7&#34;</span> <span style=color:#66d9ef>do</span> <span style=color:#75715e># every 1.week, on: :sunday, at: &#34;00:00&#34;</span>
</span></span><span style=display:flex><span>    runner(<span style=color:#66d9ef>ResetDemoData</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>and within the job, just resetting data and skipping your tables where to keep
data.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResetDemoData</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ApplicationJob</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>KEEP_MODELS</span> <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>MyInterestRate</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>YourInterestRate</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>TheirInterestRate</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>OurInterestRate</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>].</span>freeze
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>perform</span>
</span></span><span style=display:flex><span>    load_rake_tasks
</span></span><span style=display:flex><span>    delete_all_data
</span></span><span style=display:flex><span>    reseed_database
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>load_rake_tasks</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>application<span style=color:#f92672>.</span>load_tasks <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>Rake</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Task</span><span style=color:#f92672>.</span>tasks<span style=color:#f92672>.</span>empty?
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>delete_all_data</span>
</span></span><span style=display:flex><span>    conn <span style=color:#f92672>=</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span><span style=color:#f92672>.</span>connection
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    conn<span style=color:#f92672>.</span>tables<span style=color:#f92672>.</span>excluding(<span style=color:#e6db74>&#34;schema_migrations&#34;</span>)<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>t<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>next</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>KEEP_MODELS</span><span style=color:#f92672>.</span>map { <span style=color:#f92672>|</span>model<span style=color:#f92672>|</span> model<span style=color:#f92672>.</span>name<span style=color:#f92672>.</span>pluralize<span style=color:#f92672>.</span>underscore }<span style=color:#f92672>.</span>include? t
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      conn<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;TRUNCATE TABLE </span><span style=color:#e6db74>#{</span>t<span style=color:#e6db74>}</span><span style=color:#e6db74> CASCADE&#34;</span>)
</span></span><span style=display:flex><span>      conn<span style=color:#f92672>.</span>reset_pk_sequence!(t) <span style=color:#75715e># reset pk counter (optional)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>reseed_database</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Rake</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Task</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#34;db:seed&#34;</span><span style=color:#f92672>].</span>execute
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Now you are able to drop all your data except some tables you wanna keep.</p></div><footer class=post-footer>Please comment @github: <a href="https://github.com/dvogt23/blog/issues/new?labels=comment&amp;title=Page: Rails%20-%20drop%20database%20data" target=_blank>comment</a></footer></article><footer><div class=copyright>Â© dima 2018</div><div class=poweredby><a href=https://gohugo.io/ target=_blank>hugo</a>/<a href=https://github.com/gyorb/hugo-dusk target=_blank>hugo-dusk</a></div></footer></div></body></html>