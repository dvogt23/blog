<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=author content><meta name=description content="personal developer blog for some coding notes."><meta name=keywords content="blog,tech,develop,software,coding"><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><link rel=canonical href=/posts/2025-06-05-upgrade-postgres-for-nextcloud/><base href=/><meta property="og:title" content="Upgrade postgres for nextcloud"><meta property="og:description" content="Postgres upgrade for nextcloud After realizing I&rsquo;m using an old (v11) version of PostgreSQL for my nextcloud, I decide to upgrade this to a newer one, v15. In the end, it wasn&rsquo;t that easy to do this, as many of the instructions sounded like: &ldquo;just do a dump of your data and import them to the new version&rdquo;, but it won&rsquo;t. So if you have a similar problem, I summarize my process here:"><meta property="og:type" content="article"><meta property="og:url" content="/posts/2025-06-05-upgrade-postgres-for-nextcloud/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-05T11:49:48+02:00"><meta property="article:modified_time" content="2025-06-05T14:33:56+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Upgrade postgres for nextcloud"><meta name=twitter:description content="Postgres upgrade for nextcloud After realizing I&rsquo;m using an old (v11) version of PostgreSQL for my nextcloud, I decide to upgrade this to a newer one, v15. In the end, it wasn&rsquo;t that easy to do this, as many of the instructions sounded like: &ldquo;just do a dump of your data and import them to the new version&rdquo;, but it won&rsquo;t. So if you have a similar problem, I summarize my process here:"><meta itemprop=name content="Upgrade postgres for nextcloud"><meta itemprop=description content="Postgres upgrade for nextcloud After realizing I&rsquo;m using an old (v11) version of PostgreSQL for my nextcloud, I decide to upgrade this to a newer one, v15. In the end, it wasn&rsquo;t that easy to do this, as many of the instructions sounded like: &ldquo;just do a dump of your data and import them to the new version&rdquo;, but it won&rsquo;t. So if you have a similar problem, I summarize my process here:"><meta itemprop=datePublished content="2025-06-05T11:49:48+02:00"><meta itemprop=dateModified content="2025-06-05T14:33:56+02:00"><meta itemprop=wordCount content="434"><meta itemprop=keywords content="nextcloud,postgresql,docker,upgrade,how-to,"><link rel=stylesheet href=css/layout.css><link rel=stylesheet href=css/syntax.css><link rel=stylesheet href=css/tweet.css><style type=text/css>body{background-color:#202020;color:#dbdbdb}a{color:#dbdbdb}pre{background:#1d1f21;border:1px solid #dbdbdb;border-radius:5px}code{background:#1d1f21}blockquote{background:#1d1f21;border-left:3px solid #dbdbdb}table{margin:1em auto;border-collapse:collapse}table,th,td{border:1px solid #dbdbdb}th{background:#dbdbdb;color:#202020}.siteTitle a{color:#b3b6b7}.post .content h1{color:#b3b6b7}.post .content h2{color:#b3b6b7}.post .content h3{color:#b3b6b7}.post .content h4{color:#b3b6b7}.post .content h5{color:#b3b6b7}.post .content h6{color:#b3b6b7}.post .content a:hover{color:#b3b6b7}.social-link:hover{color:#b3b6b7}.nav-item-title:hover{color:#b3b6b7}.tag a:hover{color:#b3b6b7}.copyright{color:#404040}.poweredby{color:#404040}.poweredby a{color:#404040}.post-preview .title a{color:#b3b6b7}.content-item a:hover{text-decoration:underline;color:#b3b6b7}.post-list .title{color:#b3b6b7}.rmore{color:#b3b6b7}.terms .term a:hover{text-decoration:underline;color:#b3b6b7}</style><script async defer data-website-id=aeec65b5-9542-46f0-bd03-fa96813535bb src=https://umami.vogt.dev/umami.js></script><title>Upgrade postgres for nextcloud</title></head><body><div class=main><header><div class=header-bar><nav><div class=siteTitle><a href=/>dima.</a></div><a class=nav-item href=/now/><div class=nav-item-title>now</div></a><a class=nav-item href=/toots/><div class=nav-item-title>tweets</div></a><a class="nav-item
active" href=/posts><div class=nav-item-title>blog</div></a><a class=nav-item href=/><div class=nav-item-title>web</div></a><a class=nav-item href=/tags/><div class=nav-item-title>tags</div></a><a class=nav-item href=/index.xml><div class=nav-item-title>rss</div></a></nav></div><div class=social-links-header></div></header><article class=post><h1 class=title>Upgrade postgres for nextcloud</h1><p class=description></p><div class=content><h1 id=postgres-upgrade-for-nextcloud>Postgres upgrade for nextcloud</h1><p>After realizing I&rsquo;m using an old (v11) version of PostgreSQL for my nextcloud, I decide to upgrade this to a newer one, v15.
In the end, it wasn&rsquo;t that easy to do this, as many of the instructions sounded like: &ldquo;just do a dump of your data and import them to the new version&rdquo;,
but it won&rsquo;t. So if you have a similar problem, I summarize my process here:</p><p>Just some of my errors I got:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>FATAL:  password authentication failed <span style=color:#66d9ef>for</span> user <span style=color:#e6db74>&#34;oc_admin&#34;</span>
</span></span><span style=display:flex><span>User <span style=color:#e6db74>&#34;nextcloud&#34;</span> does not have a valid SCRAM secret
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span></code></pre></div><h2 id=prerequisites>Prerequisites</h2><ul><li>Docker and docker compose installed</li><li>Access to your nextcloud and postgreSQL containers</li><li>Backup storage for your database dumps and data directory</li></ul><h2 id=step-by-step-upgrade-instructions>Step-by-Step Upgrade Instructions</h2><ol><li><p><strong>Shut down all containers</strong></p><p>Stop all running containers to prevent data changes during the upgrade:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker-compose down
</span></span></code></pre></div></li><li><p><strong>Start only the database container</strong></p><p>Bring up just the PostgreSQL container so you can create backups:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker-compose up -d db
</span></span></code></pre></div></li><li><p><strong>Create a SQL dump backup</strong></p><p>Dump your entire database to a file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker exec --user postgres nextcloud-db pg_dump --dbname<span style=color:#f92672>=</span>postgresql://nextcloud:&lt;password&gt;@nextcloud-db/nextcloud -f /var/lib/postgres/nextcloud.sql
</span></span></code></pre></div></li><li><p><strong>Dump users and roles separately</strong></p><p>It&rsquo;s a good practice to export users and roles:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker exec --user postgres nextcloud-db pg_dumpall -r --dbname<span style=color:#f92672>=</span>postgresql://nextcloud:&lt;password&gt;@nextcloud-db/nextcloud -f /var/lib/postgres/user_roles.sql
</span></span></code></pre></div></li><li><p><strong>Shut down the database container</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker-compose down
</span></span></code></pre></div></li><li><p><strong>Update postgreSQL version in docker compose</strong></p><p>Edit your <code>docker-compose.yml</code> file and change the postgreSQL image tag to the desired new version, for example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres:15</span>
</span></span></code></pre></div></li><li><p><strong>Backup your old postgreSQL data directory</strong></p><p>Before starting the new container, back up your existing data directory (usually mapped as a docker volume or local path):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cp -r ./pg_data pg_data.old
</span></span></code></pre></div></li><li><p><strong>Start the new database container</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker-compose up -d db
</span></span></code></pre></div></li><li><p><strong>Drop and re-create a new nextcloud database</strong></p><p>Connect to psql of your db</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker exec -it --user postgres nextcloud-db psql --dbname<span style=color:#f92672>=</span>postgresql://nextcloud:&lt;password&gt;@nextcloud-db
</span></span></code></pre></div><p>Inside the psql prompt, drop the existing database and create a new one:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>DATABASE</span> nextcloud;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>DATABASE</span> nextcloud <span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>OWNER</span> nextcloud <span style=color:#66d9ef>ENCODING</span> <span style=color:#e6db74>&#39;UTF8&#39;</span> LC_COLLATE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;C&#39;</span> LC_CTYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;C&#39;</span> <span style=color:#66d9ef>TEMPLATE</span> template0;
</span></span></code></pre></div></li><li><p><strong>Import users and roles</strong></p><p>Restore the roles:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker exec --user postgres nextcloud-db psql --dbname<span style=color:#f92672>=</span>postgresql://nextcloud:&lt;password&gt;@nextcloud-db/nextcloud -f /var/lib/postgresql/data/user_roles.sql
</span></span></code></pre></div></li><li><p><strong>Import the data dump</strong></p><p>Restore the database:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker exec --user postgres nextcloud-db psql --dbname<span style=color:#f92672>=</span>postgresql://nextcloud:&lt;password&gt;@nextcloud-db/nextcloud -f /var/lib/postgresql/data/nextcloud.sql
</span></span></code></pre></div></li><li><p><strong>Reset user passwords</strong></p><p>Connect to PostgreSQL and reset passwords for your nextcloud users:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker exec -it --user postgres nextcloud-db psql --dbname<span style=color:#f92672>=</span>postgresql://nextcloud:&lt;password&gt;@nextcloud-db/nextcloud
</span></span></code></pre></div><p>Inside psql run commands:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>nextcloud<span style=color:#f92672>=#</span> <span style=color:#960050;background-color:#1e0010>\</span>password nextcloud
</span></span><span style=display:flex><span>nextcloud<span style=color:#f92672>=#</span> <span style=color:#960050;background-color:#1e0010>\</span>password oc_admin
</span></span></code></pre></div></li><li><p><strong>Restart all docker containers</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker-compose restart
</span></span></code></pre></div></li></ol><h2 id=final-checks>Final Checks</h2><ul><li>Verify nextcloud is running and can connect to the database.</li><li>Check logs for any errors.</li><li>Remove old backups if everything works as expected.</li></ul><p><strong>Note:</strong> The boilerplate instructions were generated with the assistance of a large language model (LLM).</p></div><footer class=post-footer>Please comment @github: <a href="https://github.com/dvogt23/blog/issues/new?labels=comment&amp;title=Page: Upgrade%20postgres%20for%20nextcloud" target=_blank>comment</a></footer></article><footer><div class=copyright>© dima 2018</div><div class=poweredby><a href=https://gohugo.io/ target=_blank>hugo</a>/<a href=https://github.com/gyorb/hugo-dusk target=_blank>hugo-dusk</a></div></footer></div></body></html>